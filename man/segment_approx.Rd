% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/segment_approx.R
\name{segment_approx}
\alias{segment_approx}
\title{Approximate Ward Segmentation of a Data Cube (Scalable)}
\usage{
segment_approx(input, Ncomp = 5, sample_n = 10000, pca_k = 20, redshift = 0)
}
\arguments{
\item{input}{A FITS object representing the input data cube. Typically, this is an IFU data cube.}

\item{Ncomp}{Integer, the number of clusters to form.}

\item{sample_n}{Integer, number of valid pixels sampled to build the Ward dendrogram.
Larger values better approximate exact Ward but increase runtime and memory (\eqn{O(sample\_n^2)}).}

\item{pca_k}{Integer, number of principal components retained for clustering and assignment.
Must be \eqn{\le} the number of spectral variables. Smaller values can improve robustness and speed,
but may smooth over narrow spectral features.}

\item{redshift}{Numeric, the redshift to apply for wavelength correction. Defaults to 0 (no correction).}
}
\value{
A list containing:
\item{cluster_map}{A \code{n_rows x n_cols} matrix of cluster assignments (integers), aligned with the original cube layout.}
\item{valid}{Integer vector of linear indices for pixels used in the segmentation (after validity filtering).}
\item{pca}{The PCA object returned by \code{\link[irlba]{prcomp_irlba}} (useful for diagnostics and projections).}
\item{centers}{A \code{Ncomp x pca_k} matrix of cluster centroids in PCA space.}
}
\description{
This function performs a scalable, approximate version of Ward hierarchical
clustering for IFU/hyperspectral data cubes. The cube is flattened into a
2D matrix (spatial pixels \eqn{\times} spectral variables), robustly scaled
row-wise, optionally projected into a low-dimensional PCA space, and then
clustered using Ward's D2 linkage on a random subset of pixels. All remaining
valid pixels are assigned to the nearest cluster centroid in PCA space.
}
\details{
Compared to \code{\link{segment}} (exact Ward on all valid pixels), this method
avoids constructing an \eqn{O(n^2)} distance object and is therefore suitable
for large cubes with many spatial pixels.


Steps performed by the function:
\enumerate{
  \item Reads the input FITS data cube.
  \item Converts the cube into a 2D matrix (spatial pixels x spectral variables).
  \item Identifies valid pixels by requiring: (i) a minimum fraction of finite spectral values,
        (ii) non-zero robust scatter (MAD) across the spectrum, and (iii) positive finite energy.
  \item Scales each valid spectrum robustly (median/MAD; falls back to SD if needed), replacing any
        non-finite scaled values with zero.
  \item Computes a truncated PCA of the scaled spectra using \code{\link[irlba]{prcomp_irlba}} and
        retains \code{pca_k} components.
  \item Randomly samples \code{sample_n} valid pixels in PCA space, computes pairwise distances,
        and performs Ward's D2 hierarchical clustering via \code{\link[fastcluster]{hclust}}.
  \item Cuts the dendrogram into \code{Ncomp} clusters and computes cluster centroids in PCA space
        from the sampled pixels.
  \item Assigns all valid pixels to the nearest centroid in PCA space (blockwise for memory efficiency).
  \item Reshapes assignments into a 2D cluster map matching the spatial dimensions of the input cube.
}
}
\section{Notes on approximation}{

This function is not identical to exact Ward clustering on all pixels. The dendrogram
is built on a subset of pixels and the final labeling is obtained by nearest-centroid
assignment in PCA space. For large cubes, this trade-off typically yields similar
large-scale segmentations at a fraction of the computational cost.
}

\examples{
\dontrun{
# Read a FITS cube and run scalable Ward segmentation
input_cube <- FITSio::readFITS("manga_7443_12703_LOGCUBE.fits")

seg <- segment_ward_approx(
  input    = input_cube,
  Ncomp    = 5,
  sample_n = 10000,
  pca_k    = 20
)

cluster_map <- seg$cluster_map
valid_idx   <- seg$valid
}

}
\seealso{
\code{\link{segment}}, \code{\link[irlba]{prcomp_irlba}},
  \code{\link[fastcluster]{hclust}}, \code{\link[stats]{cutree}}
}
