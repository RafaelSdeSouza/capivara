% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/segment_robust.R
\name{segment_robust}
\alias{segment_robust}
\title{Cluster a 2D Representation of an IFU Data Cube (Robust Version)}
\usage{
segment_robust(input, Ncomp = 5, redshift = 0, scale_fn = median_scale)
}
\arguments{
\item{input}{A FITS-like list object containing:
\describe{
  \item{\code{imDat}}{A 3D numeric array \code{[n_row, n_col, n_wave]} representing
    the IFU data cube.}
  \item{\code{hdr}}{Header metadata (e.g., FITS header).}
  \item{\code{axDat}}{Axis information such as wavelength and spatial coordinates.}
}}

\item{Ncomp}{Integer, the number of clusters to generate.}

\item{redshift}{Numeric redshift to apply for wavelength correction
(currently unused but reserved for future extensions). Defaults to 0.}

\item{scale_fn}{Deprecated — kept for backward compatibility. The robust
version implements its own safe scaling internally and ignores this argument.}
}
\value{
A list containing:
\describe{
  \item{\code{cluster_map}}{An integer matrix \code{[n_row × n_col]}
        assigning each valid pixel to a cluster; invalid pixels are \code{NA}.}
  \item{\code{header}}{The original cube header.}
  \item{\code{axDat}}{Axis metadata (e.g., wavelengths, coordinates).}
  \item{\code{cluster_snr}}{Numerical SNR estimate for each cluster.}
  \item{\code{original_cube}}{The unmodified input cube.}
}
}
\description{
This function performs unsupervised clustering on a spectral data cube
(e.g., IFU data) using a *robust preprocessing pipeline* designed to handle
missing values, masked pixels, negative fluxes, and low-variance spectra.
}
\details{
The cube is flattened into a 2D matrix (spatial pixels × spectral channels),
filtered to remove invalid or uninformative spectra, scaled using a robust
per-row transformation, and clustered via Ward’s hierarchical method using
pairwise distances computed by \code{\link{torch_dist}}.


The robust segmentation pipeline applies the following steps:

\enumerate{

  \item \textbf{Reshape the cube} into a 2D matrix
    \code{IFU2D = pixels × wavelengths}.

  \item \textbf{Validity filtering of spectra} using three complementary criteria:
    \itemize{
      \item Fraction of finite spectral values must exceed a threshold
        (default: \eqn{\ge 80\%} or at least 10 finite samples).
      \item Spectral scatter (via MAD) must be non-zero, preventing constant or
        flat spectra from being clustered.
      \item Energy (\eqn{\sum v^2}) must be positive and finite, ensuring the
        pixel carries signal beyond pure noise or NaNs.
    }
    Only pixels passing \emph{all} filters are clustered.

  \item \textbf{Robust row-wise scaling} using a custom safe scaling function:
    \itemize{
      \item Centering with the median of finite values.
      \item Scaling with MAD; if MAD = 0, fallback to SD; if SD = 0, fallback to zeros.
      \item All non-finite results are replaced with 0.
    }
    This guarantees a fully finite matrix for distance computation.

  \item \textbf{Distance computation} using \code{\link{torch_dist}}
    to generate pairwise L1 distances in a memory-efficient way.

  \item \textbf{Hierarchical clustering} with Ward.D2 linkage
    via \code{\link[fastcluster]{hclust}}.

  \item \textbf{Reprojection of clusters} into a 2D spatial
    cluster map \code{n_row × n_col}, with invalid pixels filled as \code{NA}.

  \item \textbf{Cluster SNR estimation} using a robust definition avoiding
    negative flux or zero-noise instabilities:
    \deqn{ \mathrm{SNR} = \frac{\sum S}{\sqrt{\sum N^2}} }
    where invalid or zero-noise pixels are safely handled.

}

This robust workflow avoids failures common in IFU segmentation:
\itemize{
  \item NaN / Inf contamination,
  \item flat or zero-variance spectra,
  \item negative fluxes after sky subtraction,
  \item distance matrix instabilities,
  \item meaningless clusters from blank spaxels.
}
}
\examples{
\dontrun{
  input_cube <- FITSio::readFITS("manga_cube.fits")
  result <- segment(input_cube, Ncomp = 5)
  image(result$cluster_map)
}

}
\seealso{
\code{\link{torch_dist}},
  \code{\link[fastcluster]{hclust}},
  \code{\link[stats]{cutree}}
}
