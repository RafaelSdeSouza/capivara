% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/segment_blockward.R
\name{segment_blockward}
\alias{segment_blockward}
\title{Segment an IFU cube via spatial block aggregation + Ward.D2}
\usage{
segment_blockward(
  input,
  Ncomp = 5,
  redshift = 0,
  scale_fn = NULL,
  block_size = NULL,
  ram_gb = 32,
  frac_for_dist = 0.25,
  m_cap = NULL,
  agg_fn = c("median", "mean"),
  valid_mode = c("signal", "finite_frac"),
  min_finite_frac = 0.8,
  min_block_finite_frac = 0.8,
  use_pca = FALSE,
  pca_k = 30,
  seed = 42,
  scale_first = TRUE,
  full_res_assign = TRUE,
  dist_method = c("capivara_l1", "euclidean"),
  pixel_assign = c("l1_nearest_center", "l2_nearest_center"),
  polish_iters = 0L,
  refine = TRUE,
  refine_radius = 1L,
  refine_max_pixels = 50000L,
  verbose = TRUE
)
}
\arguments{
\item{input}{A FITS-like object with field \code{imDat} as a 3-D numeric array
[n_row, n_col, n_wave]. Compatible with \code{cube_to_matrix()}.}

\item{Ncomp}{Integer, number of clusters.}

\item{redshift}{Numeric, redshift for wavelength correction (placeholder here; not applied).}

\item{scale_fn}{Function for robust row-wise scaling. If NULL, uses internal \code{safe_scale()}.}

\item{block_size}{Integer, block size in pixels. If NULL, chosen from RAM via \code{choose_block_size()}.}

\item{ram_gb}{Numeric, available RAM used for selecting block_size when \code{block_size=NULL}.}

\item{frac_for_dist}{Fraction of RAM to budget for the condensed distance vector.}

\item{m_cap}{Practical cap on number of blocks to avoid time blowups; defaults depend on ram_gb.}

\item{agg_fn}{Aggregation for block spectra: "median" (default) or "mean".}

\item{min_finite_frac}{Minimum fraction of finite values required per pixel spectrum to be valid.
Used for boundary refinement (and for optional pixel validity masks).}

\item{min_block_finite_frac}{Minimum fraction of finite values required per *block spectrum*.}

\item{use_pca}{Logical. If TRUE, run PCA on scaled block spectra before Ward.}

\item{pca_k}{Integer, number of PCA components if use_pca=TRUE.}

\item{seed}{Integer random seed (only used if needed; currently not used).}

\item{refine}{Logical. If TRUE, refine only boundary pixels at full resolution.}

\item{refine_radius}{Integer, neighborhood radius (in pixels) for detecting boundary pixels.}

\item{refine_max_pixels}{Integer cap on number of pixels to refine (safety).}

\item{verbose}{Logical.}

\item{block_assign_space}{"pca" or "scaled". Space used for refinement distances.}
}
\value{
A list with:
\itemize{
  \item \code{cluster_map}: [n_row x n_col] integer map (NA for invalid/unassigned).
  \item \code{block_map}: [n_row x n_col] integer block id per pixel.
  \item \code{block_labels}: integer vector of length n_blocks.
  \item \code{block_size}: chosen block size.
  \item \code{n_blocks}: number of clustered blocks.
  \item \code{pca}: PCA object (if use_pca).
  \item \code{centers}: cluster means in the chosen feature space (for refinement).
  \item \code{cluster_sizes}: cluster sizes in blocks.
}
}
\description{
This is a Ward-like approximation designed for very large IFU cutouts where
full pairwise distances over all spaxels are impossible (O(n^2) memory/time).
The cube is first aggregated in the *spatial* domain into macro-spaxels
(blocks) of size block_size x block_size. A robust representative spectrum is
computed per block (median across pixels, ignoring NA/Inf). Ward.D2 clustering
is then performed on block spectra (optionally after PCA), and the resulting
block labels are expanded back to the original spatial resolution.
}
\details{
Optional boundary refinement reassigns only pixels near cluster borders using
a Ward-consistent Î”SSE rule, yielding sharper edges while keeping runtime low.
}
